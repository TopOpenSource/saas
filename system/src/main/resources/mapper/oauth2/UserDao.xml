<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sdstc.oauth2.dao.UserDao">
	<resultMap id="RoleMap" type="com.sdstc.oauth2.model.Role">
		<id column="id" property="id" />
		<result column="code" property="code" />
		<result column="name" property="name" />
	</resultMap>

	<resultMap id="PermMap" type="com.sdstc.oauth2.model.Perm">
		<id column="id" property="id" />
		<result column="code" property="code" />
		<result column="name" property="name" />
	</resultMap>

	<resultMap id="UserInfoMap" type="com.sdstc.oauth2.model.UserInfo">
		<id column="id" property="id" />
		<result column="account" property="account" />
		<result column="name" property="name" />
		<result column="pwd" property="pwd" />
		<result column="state" property="state" />
		<result column="is_delete" property="isDelete" />
		<result column="phone" property="phone" />
		<result column="email" property="email" />
	</resultMap>

	<resultMap id="CustomerMap" type="com.sdstc.oauth2.model.Customer">
		<id column="id" property="id" />
		<result column="name" property="name" />
		<result column="state" property="state" />
	</resultMap>

 
	<select id="getRolesByUser" resultMap="RoleMap">
        select 
          t2.id,t2.code,t2.name 
        from 
          sys_user_role t1
		  left join sys_role t2 on t1.role_id=t2.id
		where 
		t1.is_delete = '0' 
		and t1.user_account=#{account}
		and t1.customer_id=#{customerId}        
	</select>

	<select id="getPermsByUser" resultMap="PermMap">
       select 
         t3.id,t3.code,t3.name 
       from 
         sys_role_perm t1
		 left join sys_user_role t2 on t1.role_id=t2.role_id
		 left join sys_perm t3 on t1.perm_id=t3.id
      where 
		 t2.user_account=#{account}
		 and t2.customer_id=#{customerId}
		 and t2.is_delete = '0'  
	</select>

	<select id="getCustomersByUser" resultMap="CustomerMap" parameterType="com.sdstc.oauth2.model.UserInfo">
         SELECT 
            DISTINCT( t2.id ) AS id,t2.NAME,t2.state
		 FROM
			sys_user_org t1
			LEFT JOIN sys_customer t2 ON t1.customer_id = t2.id
         <where>
             <if test="account!=null">
             and t1.user_account=#{account}
             </if>
             <if test="customerId!=null">
             and t2.id=#{customerId}
             </if>
			 and t1.state='1'
         </where>  
	</select>

	<select id="getUser" resultMap="UserInfoMap">
		select
		aa.id,
		aa.name,
		aa.account,
		aa.phone,
		aa.email,
		aa.pwd,
		aa.state,
		aa.is_delete
		from
		sys_user aa
		<where>
		(aa.account=#{account} or aa.phone=#{account} or aa.email=#{account})
		and aa.state='1'
		and aa.is_delete = '0'
		</where>
	</select>
</mapper>